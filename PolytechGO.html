<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tomsk AR Quest</title>
    <!-- A-Frame for WebAR -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/aframe/1.4.2/aframe.min.js"></script>
    <!-- AR.js for location-based AR -->
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: Arial, sans-serif;
        }
        
        #ui-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 1000;
            padding: 10px;
            box-sizing: border-box;
            pointer-events: none;
        }
        
        .collection-counter {
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px;
            border-radius: 8px;
            display: inline-block;
            pointer-events: auto;
            margin-bottom: 8px;
        }
        
        .accuracy-display {
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px;
            border-radius: 8px;
            display: block;
            pointer-events: auto;
            font-size: 14px;
        }
        
        .accuracy-good {
            color: #4caf50;
        }
        
        .accuracy-medium {
            color: #ff9800;
        }
        
        .accuracy-poor {
            color: #f44336;
        }
        
        #notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            z-index: 2000;
            display: none;
        }
        
        #collection-view {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            text-align: center;
            line-height: 60px;
            font-size: 30px;
            pointer-events: auto;
            cursor: pointer;
        }
        
        #collection-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 60%;
            background-color: white;
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            z-index: 3000;
            overflow-y: auto;
            display: none;
            padding: 20px;
            box-sizing: border-box;
        }
        
        .model-item {
            display: inline-block;
            width: 100px;
            height: 150px;
            margin: 10px;
            text-align: center;
        }
        
        .model-preview {
            width: 100px;
            height: 100px;
            background-color: #f0f0f0;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .close-panel {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 24px;
            cursor: pointer;
        }

        .coordinates-display {
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px;
            border-radius: 8px;
            display: block;
            pointer-events: auto;
            font-size: 14px;
            margin-top: 8px;
        }
    </style>
</head>
<body>
    <div id="ui-container">
        <div class="collection-counter">
            –°–æ–±—Ä–∞–Ω–æ –æ–±—ä–µ–∫—Ç–æ–≤: <span id="collected-count">0</span> / <span id="total-count">0</span>
        </div>
        <div class="accuracy-display">
            –¢–æ—á–Ω–æ—Å—Ç—å –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è: <span id="accuracy-value">–û–∂–∏–¥–∞–Ω–∏–µ GPS...</span>
        </div>
        <div class="coordinates-display">
            –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: <span id="current-coordinates">–û–∂–∏–¥–∞–Ω–∏–µ GPS...</span>
        </div>
    </div>
    
    <div id="notification">
        <h3>–û–±—ä–µ–∫—Ç –Ω–∞–π–¥–µ–Ω!</h3>
        <p id="notification-text">–í—ã –Ω–∞—à–ª–∏ –Ω–æ–≤—ã–π –æ–±—ä–µ–∫—Ç!</p>
    </div>
    
    <div id="collection-view">üëú</div>
    
    <div id="collection-panel">
        <div class="close-panel">√ó</div>
        <h2>–í–∞—à–∞ –∫–æ–ª–ª–µ–∫—Ü–∏—è</h2>
        <div id="collection-items"></div>
    </div>
    
    <a-scene 
        vr-mode-ui="enabled: false"
        arjs="sourceType: webcam; videoTexture: true; debugUIEnabled: false;"
        renderer="logarithmicDepthBuffer: true;">
        
        <!-- Camera -->
        <a-camera gps-camera rotation-reader></a-camera>
        
        <!-- AR models will be added here dynamically -->
    </a-scene>
    
    <script>
        // Define Tomsk model locations with geometric primitives
        const arModels = [

        {
                id: 1,
                name: "–¢–æ–º—Å–∫–∏–π –ü–æ–ª–∏—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç",
                description: "–°—Ç–∞—Ä–µ–π—à–∏–π —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç –≤ –°–∏–±–∏—Ä–∏, –æ—Å–Ω–æ–≤–∞–Ω –≤ 1878 –≥–æ–¥—É.",
                primitive: "box",
                color: "#4285F4",
                latitude: 56.45626892405372,  // –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã 10–∫–∏
                longitude: 84.95068666276242,
                scale: "3 3 3",
                rotation: "0 45 0",
                collectionMessage: "–í—ã —Å–æ–±—Ä–∞–ª–∏ —ç–ª–µ–º–µ–Ω—Ç –¢–æ–º—Å–∫–æ–≥–æ –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–∞!",
                collected: false
            }
        /*
            {
                id: 1,
                name: "–¢–æ–º—Å–∫–∏–π –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω—ã–π —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç",
                description: "–°—Ç–∞—Ä–µ–π—à–∏–π —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç –≤ –°–∏–±–∏—Ä–∏, –æ—Å–Ω–æ–≤–∞–Ω –≤ 1878 –≥–æ–¥—É.",
                primitive: "box",
                color: "#4285F4",
                latitude: 56.47421,  // –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –¢–ì–£
                longitude: 84.95081,
                scale: "1 1 1",
                rotation: "0 45 0",
                collectionMessage: "–í—ã —Å–æ–±—Ä–∞–ª–∏ —ç–ª–µ–º–µ–Ω—Ç –¢–æ–º—Å–∫–æ–≥–æ –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–∞!",
                collected: false
            }*/
            ,
            {
                id: 2,
                name: "–ü–∞–º—è—Ç–Ω–∏–∫ –ß–µ—Ö–æ–≤—É",
                description: "–ó–Ω–∞–º–µ–Ω–∏—Ç—ã–π –ø–∞–º—è—Ç–Ω–∏–∫ —Ä–∞–±–æ—Ç—ã —Å–∫—É–ª—å–ø—Ç–æ—Ä–∞ –õ–µ–æ–Ω—Ç–∏—è –£—Å–æ–≤–∞.",
                primitive: "cylinder",
                color: "#DB4437",
                latitude: 56.48436,  // –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ø–∞–º—è—Ç–Ω–∏–∫–∞ –ß–µ—Ö–æ–≤—É
                longitude: 84.94749,
                scale: "0.8 1.5 0.8",
                rotation: "0 0 0",
                collectionMessage: "–í—ã –æ—Ç–∫—Ä—ã–ª–∏ –ø–∞–º—è—Ç–Ω–∏–∫ –ß–µ—Ö–æ–≤—É!",
                collected: false
            },
            {
                id: 3,
                name: "–î–µ—Ä–µ–≤—è–Ω–Ω—ã–π –¥–æ–º —Å –Ω–∞–ª–∏—á–Ω–∏–∫–∞–º–∏",
                description: "–û–¥–∏–Ω –∏–∑ –∑–Ω–∞–º–µ–Ω–∏—Ç—ã—Ö –¥–µ—Ä–µ–≤—è–Ω–Ω—ã—Ö –¥–æ–º–æ–≤ –¢–æ–º—Å–∫–∞.",
                primitive: "cone",
                color: "#F4B400",
                latitude: 56.48227,  // –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –¥–µ—Ä–µ–≤—è–Ω–Ω–æ–≥–æ –¥–æ–º–∞ (–ø—Ä–∏–º–µ—Ä)
                longitude: 84.95101,
                scale: "1 1 1",
                rotation: "0 0 0",
                collectionMessage: "–î–µ—Ä–µ–≤—è–Ω–Ω—ã–π –¥–æ–º —Ç–µ–ø–µ—Ä—å –≤ –≤–∞—à–µ–π –∫–æ–ª–ª–µ–∫—Ü–∏–∏!",
                collected: false
            },
            {
                id: 4,
                name: "–õ–∞–≥–µ—Ä–Ω—ã–π —Å–∞–¥",
                description: "–ö—Ä–∞—Å–∏–≤—ã–π –ø–∞—Ä–∫ —Å –≤–∏–¥–æ–º –Ω–∞ —Ä–µ–∫—É –¢–æ–º—å.",
                primitive: "sphere",
                color: "#0F9D58",
                latitude: 56.45452,  // –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –õ–∞–≥–µ—Ä–Ω–æ–≥–æ —Å–∞–¥–∞
                longitude: 84.95146,
                scale: "1 1 1",
                rotation: "0 0 0",
                collectionMessage: "–í—ã –¥–æ–±–∞–≤–∏–ª–∏ –õ–∞–≥–µ—Ä–Ω—ã–π —Å–∞–¥ –≤ —Å–≤–æ—é –∫–æ–ª–ª–µ–∫—Ü–∏—é!",
                collected: false
            },
            {
                id: 5,
                name: "–ù–æ–≤–æ—Å–æ–±–æ—Ä–Ω–∞—è –ø–ª–æ—â–∞–¥—å",
                description: "–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è –ø–ª–æ—â–∞–¥—å –¢–æ–º—Å–∫–∞.",
                primitive: "tetrahedron",
                color: "#9C27B0",
                latitude: 56.47654,  // –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ù–æ–≤–æ—Å–æ–±–æ—Ä–Ω–æ–π –ø–ª–æ—â–∞–¥–∏
                longitude: 84.95077,
                scale: "1 1 1",
                rotation: "0 45 0",
                collectionMessage: "–í—ã —Å–æ–±—Ä–∞–ª–∏ —ç–ª–µ–º–µ–Ω—Ç –ù–æ–≤–æ—Å–æ–±–æ—Ä–Ω–æ–π –ø–ª–æ—â–∞–¥–∏!",
                collected: false
            }
        ];
        
        document.addEventListener('DOMContentLoaded', function() {
            // Set total model count
            document.getElementById('total-count').textContent = arModels.length;
            
            // Create AR entities for each model
            const scene = document.querySelector('a-scene');
            
            arModels.forEach(modelData => {
                // Create primitive entity
                const entity = document.createElement('a-entity');
                entity.setAttribute('gps-entity-place', `latitude: ${modelData.latitude}; longitude: ${modelData.longitude}`);
                entity.setAttribute('data-model-id', modelData.id);
                
                // Create the primitive
                let primitive;
                
                if (modelData.primitive === "tetrahedron") {
                    // Custom tetrahedron (using an entity with a special geometry)
                    primitive = document.createElement('a-entity');
                    primitive.setAttribute('geometry', 'primitive: tetrahedron');
                } else {
                    // Standard A-Frame primitives
                    primitive = document.createElement(`a-${modelData.primitive}`);
                }
                
                // Set properties based on primitive type
                primitive.setAttribute('color', modelData.color);
                
                // Set scale and animation
                entity.setAttribute('scale', modelData.scale);
                entity.setAttribute('rotation', modelData.rotation);
                entity.setAttribute('animation', 'property: rotation; to: 0 360 0; loop: true; dur: 15000; easing: linear');
                
                // Add collection event
                entity.addEventListener('click', () => {
                    collectModel(modelData.id);
                });
                
                // Make primitive semi-transparent
                primitive.setAttribute('opacity', '0.7');
                
                // Add primitive to entity
                entity.appendChild(primitive);
                
                // Add entity to scene
                scene.appendChild(entity);
            });
            
            // Initialize user location monitoring
            if ('geolocation' in navigator) {
                navigator.geolocation.watchPosition(position => {
                    const accuracy = position.coords.accuracy;
                    const latitude = position.coords.latitude;
                    const longitude = position.coords.longitude;
                    
                    // Update accuracy display
                    updateAccuracyDisplay(accuracy);
                    
                    // Update coordinates display
                    updateCoordinatesDisplay(latitude, longitude);
                    
                    // Check proximity for collection
                    checkProximity(latitude, longitude);
                }, err => {
                    console.error('Error getting location:', err);
                    alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–∫–ª—é—á–∏—Ç–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è –¥–ª—è –∏–≥—Ä—ã –≤ AR-–∫–≤–µ—Å—Ç.');
                }, {
                    enableHighAccuracy: true,
                    maximumAge: 0,
                    timeout: 27000
                });
            }
            
            // Collection panel toggle
            document.getElementById('collection-view').addEventListener('click', toggleCollectionPanel);
            document.querySelector('.close-panel').addEventListener('click', toggleCollectionPanel);
            
            // Load collection from localStorage if available
            loadCollection();
            
            // Add custom tetrahedron geometry
            if (!AFRAME.geometries.tetrahedron) {
                AFRAME.registerGeometry('tetrahedron', {
                    init: function () {
                        var data = this.data;
                        var geometry = new THREE.TetrahedronGeometry(1, 0);
                        this.geometry = geometry;
                    }
                });
            }
        });
        
        function updateAccuracyDisplay(accuracy) {
            const accuracyElement = document.getElementById('accuracy-value');
            
            // Remove any existing classes
            accuracyElement.classList.remove('accuracy-good', 'accuracy-medium', 'accuracy-poor');
            
            // Add appropriate class and text based on accuracy
            if (accuracy <= 5) {
                accuracyElement.textContent = `${accuracy.toFixed(1)} –º (–û—Ç–ª–∏—á–Ω–∞—è)`;
                accuracyElement.classList.add('accuracy-good');
            } else if (accuracy <= 15) {
                accuracyElement.textContent = `${accuracy.toFixed(1)} –º (–°—Ä–µ–¥–Ω—è—è)`;
                accuracyElement.classList.add('accuracy-medium');
            } else {
                accuracyElement.textContent = `${accuracy.toFixed(1)} –º (–ù–∏–∑–∫–∞—è)`;
                accuracyElement.classList.add('accuracy-poor');
            }
        }
        
        function updateCoordinatesDisplay(latitude, longitude) {
            const coordsElement = document.getElementById('current-coordinates');
            coordsElement.textContent = `${latitude.toFixed(5)}, ${longitude.toFixed(5)}`;
        }
        
        function checkProximity(userLat, userLong) {
            arModels.forEach(model => {
                if (!model.collected) {
                    // Calculate distance between user and model (Haversine formula)
                    const distance = calculateDistance(
                        userLat, userLong,
                        model.latitude, model.longitude
                    );
                    
                    // If user is within 15 meters of a model, collect it
                    if (distance < 15) {
                        collectModel(model.id);
                    }
                }
            });
        }
        
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // Earth radius in meters
            const œÜ1 = lat1 * Math.PI/180;
            const œÜ2 = lat2 * Math.PI/180;
            const ŒîœÜ = (lat2-lat1) * Math.PI/180;
            const ŒîŒª = (lon2-lon1) * Math.PI/180;
            
            const a = Math.sin(ŒîœÜ/2) * Math.sin(ŒîœÜ/2) +
                Math.cos(œÜ1) * Math.cos(œÜ2) *
                Math.sin(ŒîŒª/2) * Math.sin(ŒîŒª/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            
            return R * c; // Distance in meters
        }
        
        function collectModel(modelId) {
            const modelIndex = arModels.findIndex(model => model.id === modelId);
            
            if (modelIndex !== -1 && !arModels[modelIndex].collected) {
                // Mark as collected
                arModels[modelIndex].collected = true;
                
                // Update UI counter
                const collectedCount = arModels.filter(model => model.collected).length;
                document.getElementById('collected-count').textContent = collectedCount;
                
                // Show notification
                const notification = document.getElementById('notification');
                document.getElementById('notification-text').textContent = arModels[modelIndex].collectionMessage;
                notification.style.display = 'block';
                
                // Hide notification after 3 seconds
                setTimeout(() => {
                    notification.style.display = 'none';
                }, 3000);
                
                // Update collection panel
                updateCollectionPanel();
                
                // Save to localStorage
                saveCollection();
            }
        }
        
        function toggleCollectionPanel() {
            const panel = document.getElementById('collection-panel');
            panel.style.display = panel.style.display === 'none' || panel.style.display === '' ? 'block' : 'none';
        }
        
        function updateCollectionPanel() {
            const container = document.getElementById('collection-items');
            container.innerHTML = '';
            
            arModels.forEach(model => {
                if (model.collected) {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'model-item';
                    
                    const previewDiv = document.createElement('div');
                    previewDiv.className = 'model-preview';
                    previewDiv.style.backgroundColor = model.color;
                    previewDiv.textContent = model.name.substring(0, 1);
                    
                    const nameP = document.createElement('p');
                    nameP.textContent = model.name;
                    
                    itemDiv.appendChild(previewDiv);
                    itemDiv.appendChild(nameP);
                    container.appendChild(itemDiv);
                }
            });
        }
        
        function saveCollection() {
            // Save collected models to localStorage
            const collectedIds = arModels
                .filter(model => model.collected)
                .map(model => model.id);
            
            localStorage.setItem('tomskARCollection', JSON.stringify(collectedIds));
        }
        
        function loadCollection() {
            // Load collection from localStorage
            const savedCollection = localStorage.getItem('tomskARCollection');
            
            if (savedCollection) {
                const collectedIds = JSON.parse(savedCollection);
                
                collectedIds.forEach(id => {
                    const modelIndex = arModels.findIndex(model => model.id === id);
                    if (modelIndex !== -1) {
                        arModels[modelIndex].collected = true;
                    }
                });
                
                // Update UI
                document.getElementById('collected-count').textContent = 
                    arModels.filter(model => model.collected).length;
                
                updateCollectionPanel();
            }
        }
    </script>
</body>
</html>